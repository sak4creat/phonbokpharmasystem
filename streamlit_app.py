import streamlit as st
from supabase import create_client
import pandas as pd
import datetime
import time

# --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (SETUP) ---
st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏•‡∏±‡∏á‡∏¢‡∏≤ ‡∏£‡∏û.‡∏™‡∏ï. ‡πÇ‡∏û‡∏ô‡∏ö‡∏Å", layout="wide", page_icon="üè•")

st.markdown("""
<style>
    .stButton>button { border-radius: 20px; transition: all 0.3s ease; border: 1px solid #e0e0e0; }
    .stButton>button:hover { transform: scale(1.02); border-color: #ff4b4b; color: #ff4b4b; }
    [data-testid="stForm"] { border-radius: 15px; border: 1px solid #f0f2f6; box-shadow: 0 4px 6px rgba(0,0,0,0.05); padding: 2rem; }
    [data-testid="stAlert"] { border-radius: 10px; }
    [data-testid="stMetricValue"] { color: #2e7bcf; }
</style>
""", unsafe_allow_html=True)

@st.cache_resource
def init_connection():
    try:
        url = st.secrets["supabase"]["supabase_url"]
        key = st.secrets["supabase"]["supabase_key"]
        return create_client(url, key)
    except:
        st.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Secrets! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ supabase_url ‡πÅ‡∏•‡∏∞ supabase_key ‡πÉ‡∏ô Streamlit")
        return None

supabase = init_connection()

# --- 2. ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Session (LOGIN STATE) ---
if 'user' not in st.session_state: st.session_state.user = None
if 'role' not in st.session_state: st.session_state.role = None
if 'user_email' not in st.session_state: st.session_state.user_email = None

def login_user(email, password):
    try:
        response = supabase.auth.sign_in_with_password({"email": email, "password": password})
        profile = supabase.table("profiles").select("*").eq("id", response.user.id).execute()
        if profile.data:
            if profile.data[0]['is_approved']:
                st.session_state.user = response.user
                st.session_state.role = profile.data[0]['role']
                st.session_state.user_email = email
                st.success(f"üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö! {email}")
                time.sleep(1)
                st.rerun()
            else: st.warning("‚è≥ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å Admin")
        else: st.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ")
    except Exception as e:
        st.error("‚ùå ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á")

def logout_user():
    supabase.auth.sign_out()
    st.session_state.user = None
    st.session_state.role = None
    st.rerun()

# --- 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ---
def get_medicines():
    return pd.DataFrame(supabase.table("medicines").select("*").eq("is_active", True).execute().data)

def get_inventory_view():
    meds = pd.DataFrame(supabase.table("medicines").select("id, generic_name, unit").execute().data)
    inv = pd.DataFrame(supabase.table("inventory").select("*").execute().data)
    if inv.empty: return pd.DataFrame()
    merged = pd.merge(inv, meds, left_on="medicine_id", right_on="id", how="left")
    return merged[merged['qty'] > 0]

# --- 4. ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (FRONTEND) ---
if not st.session_state.user:
    st.markdown("<br><br>", unsafe_allow_html=True)
    col1, col2, col3 = st.columns([1, 2, 1])
    with col2:
        st.image("https://cdn-icons-png.flaticon.com/512/3063/3063176.png", width=100)
        st.title("‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏•‡∏±‡∏á‡∏¢‡∏≤")
        st.markdown("##### ‡∏£‡∏û.‡∏™‡∏ï. ‡πÇ‡∏û‡∏ô‡∏ö‡∏Å üè•")
        with st.form("login_form"):
            email = st.text_input("‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô")
            password = st.text_input("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô", type="password")
            if st.form_submit_button("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö", use_container_width=True):
                login_user(email, password)
        st.caption("üí° ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà")

else:
    with st.sidebar:
        st.image("https://cdn-icons-png.flaticon.com/512/3063/3063176.png", width=60)
        st.write(f"üë§ **{st.session_state.user_email}**")
        st.caption(f"‚≠ê ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: {st.session_state.role.upper()}")
        if st.button("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö", use_container_width=True): logout_user()
        st.divider()

    menu_options = ["üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î", "üíä ‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤", "üì¶ ‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤", "üìù ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤ (Master)"]
    if st.session_state.role == 'admin': menu_options.append("üëë Admin Panel")
    menu = st.sidebar.radio("üìå ‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô", menu_options)

    if menu == "üëë Admin Panel":
        st.header("üëë ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin)")
        profiles = pd.DataFrame(supabase.table("profiles").select("*").execute().data)
        if not profiles.empty:
            profiles['status'] = profiles['is_approved'].map({True: '‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß', False: '‚è≥ ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'})
            st.dataframe(profiles[['email', 'role', 'status', 'created_at']], use_container_width=True)
            st.divider()
            st.subheader("‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô")
            pending_users = profiles[profiles['is_approved'] == False]
            if not pending_users.empty:
                user_to_approve = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥", pending_users['email'])
                c1, c2 = st.columns(2)
                if c1.button("‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Staff", use_container_width=True):
                    supabase.table("profiles").update({"is_approved": True}).eq("email", user_to_approve).execute()
                    st.success("‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!"); st.rerun()
                if c2.button("üëÆ ‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô Admin", use_container_width=True):
                    supabase.table("profiles").update({"is_approved": True, "role": "admin"}).eq("email", user_to_approve).execute()
                    st.success("‡πÅ‡∏ï‡πà‡∏á‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô Admin ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!"); st.rerun()
            else: st.info("üéâ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥")

    elif menu == "üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î":
        st.header("üìä ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ñ‡∏•‡∏±‡∏á‡∏¢‡∏≤")
        try:
            df_inv = get_inventory_view()
            if not df_inv.empty:
                total_items = df_inv['generic_name'].nunique()
                total_qty = df_inv['qty'].sum()
                df_inv['exp_date'] = pd.to_datetime(df_inv['exp_date'])
                today = pd.to_datetime(datetime.date.today())
                near_exp = df_inv[df_inv['exp_date'] <= today + pd.Timedelta(days=180)]
                
                c1, c2, c3 = st.columns(3)
                c1.metric("üìå ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ", f"{total_items}", "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
                c2.metric("üì¶ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô‡∏£‡∏ß‡∏°", f"{total_qty:,}", "Unit")
                c3.metric("üö® ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (<6‡∏î.)", f"{len(near_exp)}", "‡∏•‡πá‡∏≠‡∏ï", delta_color="inverse")
                st.divider()
                
                col_l, col_r = st.columns([2,1])
                with col_l:
                    st.subheader("‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
                    summary = df_inv.groupby(['generic_name', 'unit'])['qty'].sum().reset_index()
                    st.dataframe(summary, use_container_width=True)
                with col_r:
                    if not near_exp.empty:
                        st.subheader("‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏µ‡∏ö‡πÉ‡∏ä‡πâ (FEFO)")
                        st.dataframe(near_exp[['generic_name', 'exp_date', 'qty']], hide_index=True)
                    else: st.success("‚úÖ ‡∏Ñ‡∏•‡∏±‡∏á‡∏¢‡∏≤‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°")
            else: st.info("üì≠ ‡∏Ñ‡∏•‡∏±‡∏á‡∏¢‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå")
        except Exception as e: st.error(f"Error: {e}")

    elif menu == "üíä ‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤":
        st.header("üíä ‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå")
        df_inv = get_inventory_view()
        if not df_inv.empty:
            drug_name = st.selectbox("üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤", df_inv['generic_name'].unique())
            lots = df_inv[df_inv['generic_name'] == drug_name].sort_values("exp_date")
            st.caption(f"‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Lot ‡∏Ç‡∏≠‡∏á {drug_name} (‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß)")
            
            for idx, row in lots.iterrows():
                # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ú‡∏•‡∏¥‡∏ï‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå (‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô None)
                mfg_text = row.get('mfg_date', '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') 
                
                with st.expander(f"üì¶ Lot: {row['lot_no']} | ‡∏ú‡∏•‡∏¥‡∏ï: {mfg_text} | ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: {row['exp_date']} | ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: {row['qty']} {row['unit']}", expanded=True):
                    with st.form(f"dispense_{row['id']}"):
                        amount = st.number_input(f"‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å ({row['unit']})", min_value=1, max_value=int(row['qty']))
                        note = st.text_input("‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏", value="‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô")
                        if st.form_submit_button("‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏≤", use_container_width=True):
                            new_q = int(row['qty']) - amount
                            supabase.table("inventory").update({"qty": new_q}).eq("id", row['id']).execute()
                            supabase.table("transactions").insert({
                                "medicine_id": row['medicine_id'], "action_type": "DISPENSE",
                                "qty_change": -amount, "lot_no": row['lot_no'],
                                "user_name": st.session_state.user_email, "note": note
                            }).execute()
                            st.success("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!")
                            time.sleep(1)
                            st.rerun()

    elif menu == "üì¶ ‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤":
        st.header("üì¶ ‡∏£‡∏±‡∏ö‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á")
        meds = get_medicines()
        
        with st.form("recv_form"):
            # ‡∏î‡∏∂‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå‡πÉ‡∏ô‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö‡∏Ç‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏≤
            options = meds['id'] + " | " + meds['generic_name'] + " (" + meds['unit'] + ")"
            d_choice = st.selectbox("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≤", options)
            
            c1, c2, c3 = st.columns(3)
            lot = c1.text_input("‡∏£‡∏´‡∏±‡∏™ Lot.")
            mfg = c2.date_input("‡∏ß‡∏±‡∏ô‡∏ú‡∏•‡∏¥‡∏ï (MFG)")
            exp = c3.date_input("‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (EXP)")
            
            # ‡∏´‡∏≤‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏õ‡πÉ‡∏™‡πà‡∏ó‡πâ‡∏≤‡∏¢‡∏ä‡πà‡∏≠‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
            selected_id = d_choice.split(" | ")[0]
            selected_unit = meds[meds['id'] == selected_id]['unit'].values[0]
            
            qty = st.number_input(f"‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ ({selected_unit})", min_value=1)
            
            if st.form_submit_button("üì• ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤", use_container_width=True):
                supabase.table("inventory").insert({
                    "medicine_id": selected_id, "lot_no": lot, 
                    "mfg_date": str(mfg), "exp_date": str(exp), "qty": qty
                }).execute()
                supabase.table("transactions").insert({
                    "medicine_id": selected_id, "action_type": "RECEIVE", "qty_change": qty,
                    "lot_no": lot, "user_name": st.session_state.user_email, "note": "‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏Å‡∏ï‡∏¥"
                }).execute()
                st.success("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!")

    elif menu == "üìù ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤ (Master)":
        st.header("üìù ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏¢‡∏≤‡∏´‡∏•‡∏±‡∏Å")
        tab1, tab2 = st.tabs(["‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà", "üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà"])
        with tab1:
            with st.form("new_med"):
                c1, c2 = st.columns(2)
                nid = c1.text_input("‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô DRUG009)")
                nname = c2.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç (Generic Name)")
                nunit = c1.text_input("‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏°‡πá‡∏î, ‡∏Ç‡∏ß‡∏î, ‡∏´‡∏•‡∏≠‡∏î)")
                ncat = c2.selectbox("‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà", ["‡∏¢‡∏≤‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ", "‡∏¢‡∏≤‡∏ô‡∏≠‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ", "‡πÄ‡∏ß‡∏ä‡∏†‡∏±‡∏ì‡∏ë‡πå/‡∏ß‡∏±‡∏™‡∏î‡∏∏"])
                if st.form_submit_button("üíæ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≤", use_container_width=True):
                    try:
                        supabase.table("medicines").insert({"id": nid, "generic_name": nname, "unit": nunit, "category": ncat}).execute()
                        st.success("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!")
                    except: st.error("‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏≤‡∏ã‡πâ‡∏≥ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô")
        with tab2:
            st.dataframe(get_medicines(), use_container_width=True)
